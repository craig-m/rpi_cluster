#!/usr/sbin/nft -f

# todo: replace iptables with this
# https://wiki.gentoo.org/wiki/Nftables/Examples
#

flush ruleset

# filter, inet
table inet filter {
	chain output {
		type filter hook output priority 0; policy accept;
		counter comment "count accepted packets"
	}

	chain forward {
		type filter hook forward priority 0; policy drop;
		counter comment "count dropped packets"
	}

	chain input {
		type filter hook input priority 0; policy drop;
		ct state invalid counter drop comment "drop invalid packets"
		ct state {established, related} counter accept comment "accept all connections related to connections made by us"
		iifname lo accept comment "accept loopback"
		#iifname != lo ipv4 daddr 127.0.0.1/8 counter drop comment "drop connections to loopback not coming from loopback"
		#iifname != lo ip6 daddr ::1/128 counter drop comment "drop connections to loopback not coming from loopback"
		ip protocol icmp counter accept comment "accept all icmp types"
		ip6 nexthdr icmpv6 counter accept comment "accept all icmp types"
    # ACCEPT
    tcp dport 22 counter accept comment "accept ssh"
    tcp dport 80 counter accept comment "accept http"
    tcp dport 8080 counter accept comment "accept httpalt"
    tcp dport 3306 counter accept comment "accept mariadb"
    # DROP
		counter comment "count dropped packets"
	}
}

# nat, ipv4
table ip nat {
	chain prerouting {
		type nat hook prerouting priority 0; policy accept;
		counter comment "count accepted packets"
	}

	chain input {
		type nat hook input priority 0; policy accept;
		counter comment "count accepted packets"
	}

	chain output {
		type nat hook output priority 0; policy accept;
		counter comment "count accepted packets"
	}

	chain postrouting {
		type nat hook postrouting priority 0; policy accept;
		counter comment "count accepted packets"
	}
}

# nat, ipv6
table ip6 nat6 {
	chain prerouting {
		type nat hook prerouting priority 0; policy accept;
		counter comment "count accepted packets"
	}

	chain input {
		type nat hook input priority 0; policy accept;
		counter comment "count accepted packets"
	}

	chain output {
		type nat hook output priority 0; policy accept;
		counter comment "count accepted packets"
	}

	chain postrouting {
		type nat hook postrouting priority 0; policy accept;
		counter comment "count accepted packets"
	}
}
