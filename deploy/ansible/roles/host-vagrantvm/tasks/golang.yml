---
# install Go
# https://golang.org/dl/


# check bin exists
- name: check golang bin
  stat: path=/usr/local/go/bin/go
  register: golangbinlocal
  tags: [golang]


# src dir
- name: make /opt/cluster/mysrc/golang/
  file: path=/opt/cluster/mysrc/golang/ state=directory mode=0775


# check golang .tar.gz
- name: check golang tar gz
  stat: path=/opt/cluster/mysrc/golang/go1.9.2.linux-amd64.tar.gz
  register: golangbintargz
  tags: [golang]


# download golang
- name: download golang
  get_url:
    url: https://dl.google.com/go/go1.9.2.linux-amd64.tar.gz
    dest: /opt/cluster/mysrc/golang/
    checksum: sha256:de874549d9a8d8d8062be05808509c09a88a248e77ec14eb77453530829ac02b
  when: golangbintargz.stat.exists == False
  register: golangtargz
  tags: [golang]


# unarchive golang
- name: unarchive golang
  unarchive:
    src: /opt/cluster/mysrc/golang/go1.9.2.linux-amd64.tar.gz
    dest: /usr/local/
    mode: 0755
    remote_src: yes
  become: true
  register: golangtargzunarch
  when: golangbinlocal.stat.exists == False
  tags: [golang]


# fix perms
- name: fix perms 1
  command: find /usr/local/go/ -type f -exec chmod 644 -v {} \;
  become: true
  when: golangtargzunarch.changed
  tags: [golang]

- name: fix perms 2
  command: chmod a+x /usr/local/go/bin/go
  become: true
  when: golangtargzunarch.changed
  tags: [golang]

- name: fix perms 3
  command: chown root:root /usr/local/go/bin/go /usr/local/go/bin/godoc /usr/local/go/bin/gofmt
  become: true
  when: golangtargzunarch.changed
  tags: [golang]
