---
# Keepalived
# http://www.keepalived.org/
# http://www.keepalived.org/doc/introduction.html
- debug: msg="Keepalived install "
- debug: msg="Floating IP is {{ rpi_loadbal_float_ip }} "

# keepalived will ensure this shared IP address will be present in *at least* one place.

# install packages (if missing)
- name: install Keepalived programs
  apt: name={{ item }} state=present
  with_items:
       - keepalived
  become: yes
  environment:
    # do not start Keepalived at the end of install
    RUNLEVEL: 1
  tags: [keepalived]

#-------------------------------------------------------------------------------

- name: primary keepalived
  debug: msg="primary keepalived "
  when: "'loadbal_prime' in group_names"
  tags: [keepalived]


- name: keepalived conf for Primary
  template:
    src: primary.j2
    dest: /etc/keepalived/keepalived.conf
    mode: 0644
    owner: root
    group: root
  notify: keepalived_reload
  become: yes
  when: "'loadbal_prime' in group_names"
  tags: [keepalived]

#-------------------------------------------------------------------------------

- name: secondary keepalived
  debug: msg="secondary keepalived "
  when: "'loadbal_second' in group_names"
  tags: [keepalived]


- name: keepalived conf for Secondary
  template:
    src: secondary.j2
    dest: /etc/keepalived/keepalived.conf
    mode: 0644
    owner: root
    group: root
  notify: keepalived_reload
  become: yes
  when: "'loadbal_second' in group_names"
  tags: [keepalived]

#-------------------------------------------------------------------------------

# enabled on boot
- name: keepalived enabled on boot
  service: name=keepalived enabled=yes
  become: yes
  register: keepalived_changed
  tags: [keepalived]


# started (if flagged on)
- name: keepalived started
  service: name=keepalived state=started
  become: yes
  register: keepalived_changed
  tags: [keepalived]


# pause
- pause:
    seconds: 6
  when: keepalived_changed.changed
  changed_when: false
  tags: [keepalived]


# ping IP
- name: ping test floating IP
  command: ping -c 3 {{ rpi_loadbal_float_ip }}
  register: rpi_ping_float_ip
  changed_when: false
  tags: [keepalived]


# Log IP to ARA
- name: Log floating IP to ARA
  ara_record:
    key: "website"
    type: "url"
    value: "{{ rpi_loadbal_float_ip }}"
  tags: [keepalived]


# Save IP in Redis
- name: store float IP in redis
  local_action: command /usr/bin/redis-cli set /rpi/keepalived/ip {{ rpi_loadbal_float_ip }}
  changed_when: False
  run_once: True
  tags: [keepalived]


# log
- name: notify rpicluster log
  shell: logger -t rpicluster running Keepalived with floating IP {{ rpi_loadbal_float_ip }}
  changed_when: false
  tags: [keepalived]


- name: roles info txt
  lineinfile:
    path: /opt/cluster/data/info_roles.txt
    line: "{{ role_path|basename }}"
  become: yes
  tags: [keepalived]
