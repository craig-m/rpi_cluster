---
# tasks just for psi R-Pi
- debug: msg="psi node setup "


- name: rpi_cluster dir in homefolder
  file:
    path: ~/rpi_cluster/
    state: directory
    mode: 0770


- name: copy rpi_cluster ansible
  synchronize:
    src: ~/rpi_cluster/ansible
    dest: ~/rpi_cluster/ansible
    recursive: true
    delete: yes
    rsync_opts:
      - '--no-motd'
      - '--exclude=~/rpi_cluster/.DS_Store'


- name: copy rpi_cluster serverspec
  synchronize:
    src: ~/rpi_cluster/serverspec
    dest: ~/rpi_cluster/serverspec
    recursive: true
    delete: yes
    rsync_opts:
      - '--no-motd'
      - '--exclude=~/rpi_cluster/.DS_Store'


- name: copy rpi_cluster code
  synchronize:
    src: ~/rpi_cluster/code
    dest: ~/rpi_cluster/code
    recursive: true
    delete: yes
    rsync_opts:
      - '--no-motd'
      - '--exclude=~/rpi_cluster/.DS_Store'


- name: copy firewall script
  template:
    src: ufw.j2
    dest: /root/ufw.sh
    owner: root
    group: root
    mode: 0755
  become: yes
  changed_when: False


- name: run firewall script
  shell: /root/ufw.sh
  args:
    chdir: /root/
    creates: /root/.ufw
  become: yes


- name: copy ramstore script
  template:
    src: ramstore.j2
    dest: /root/ramstore.sh
    owner: root
    group: root
    mode: 0755
  become: yes
  changed_when: False


- name: run firewall script
  shell: /root/ramstore.sh
  args:
    chdir: /root/
    creates: /mnt/ramstore/data/test.txt
  become: yes


- name: copy vault pw
  copy:
    content: "{{ myvaultpassword }}"
    dest: "/mnt/ramstore/data/.vaultpassword"
    owner: pi
    group: pi
    mode: 0440
  become: true
  vars:
    myvaultpassword: "{{ lookup('passwordstore', 'ansible/vault/current returnall=true')}}"


# ssh-keygen -s ~/rpi_cluster/local_data/ssh/my-ssh-ca/ca -P ${thesshcapw} -I vagrant -n pi -V +4w -z 1 /opt/cluster/



- name: output to rpicluster log
  shell: logger -t rpicluster host-psi role ran
  changed_when: False


- name: roles info txt
  lineinfile:
    path: /opt/cluster/data/info_roles.txt
    line: "{{role_path|basename}}"
    owner: root
    group: root
    mode: 0444
  become: yes
