---
# compute nodes: gamma, epsilon, delta, zeta
- debug: msg="compute node tasks "
  tags: [computenode]


# java
- name: java
  apt:
    name: "{{ item }}"
    state: present
  loop:
       - openjdk-8-jdk
       - openjdk-8-doc
  become: yes
  retries: 2
  tags: [computenode]


# Create Compute Admin user
- name: compute admin user
  user:
    name: computeadm
    groups: sshusers,staff,www-data
    append: yes
    createhome: yes
    home: /home/computeadm
  become: yes
  tags: [computenode]


# Password for Compute Admin
- name: update computeadm password
  user:
    name: computeadm
    update_password: always
    password: $6$rounds=656000$YK1qnGCWOE.ssHc4$yIJ/2kWjYBcWofiygJ9x0qH9hu4nY0H60DspBkfxJ0meYvBevvr2d5J2kTW1HnR3WVv.Dj1ypdEmrrrxhvIah0
  become: yes
  tags: [computenode]


#-------------------------------------------------------------------------------


# copy lanservices-boot.sh
- name: lanservices-boot script
  template:
    src: compute-boot.j2
    dest: /opt/cluster/bin/compute-boot.sh
    mode: 0770
    owner: root
    group: root
  become: yes
  tags: [lanservices]


# systemd script
- name: copy rpi compute systemd script
  copy:
    src: rpi-compute.service
    dest: /etc/systemd/system/rpi-compute.service
    mode: 0644
    owner: root
    group: root
  become: yes
  changed_when: false
  notify:
    - systemctl-daemon-reload
    - restart-rpicompute
  tags: [computenode]


- name: enable rpi-compute systemd script
  systemd:
    name: rpi-compute
    enabled: yes
    masked: no
  become: yes
  tags: [computenode]


#-------------------------------------------------------------------------------


- name: output to rpicluster log
  shell: logger -t rpicluster compute-node role ran
  changed_when: False
  tags: [computenode]


- name: roles info txt
  lineinfile:
    path: /opt/cluster/data/info_roles.txt
    line: "{{ role_path|basename }}"
    owner: root
    group: root
    mode: 0444
  become: yes
  tags: [computenode]
