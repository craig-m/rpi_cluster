---
# busybox httpd in chroot
# https://git.busybox.net/busybox/tree/networking/httpd.c
- debug: msg="busybox httpd chroot "


# source folder
- name: make temp source folder
  file:
    path: "{{ bbhttpd_src_tmp }}"
    state: directory
    mode: 0760
  tags: [bbhttpd]


# copy files
- name: copy install files
  copy:
    src: "{{ item.src }}"
    dest: "{{ bbhttpd_src_tmp }}/"
    mode: 0644
  with_items: "{{ files }}"
  tags: [bbhttpd]


# chmod +x install script
- name: make install script exec
  file:
    dest: "{{ bbhttpd_src_tmp }}/chroot_bb.sh"
    mode: 0755
  become: yes
  when: rpi_bb_httpd_enabled == true
  register: pi_bb_httpd_script
  tags: [bbhttpd]


# run installer script
- name: install busybox chroot
  command: "{{ bbhttpd_src_tmp }}/chroot_bb.sh"
  become: yes
  when:
    - "rpi_bb_httpd_enabled == true"
    - pi_bb_httpd_script.changed
  tags:
   - bbhttpd
   - skip_ansible_lint


# index.html
- name: index.html template
  template:
    src: ansible-index.j2
    dest: /opt/chroot_bb/www/index.html
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
    mode: 0644
  become: yes
  changed_when: false
  when: rpi_bb_httpd_enabled == true
  tags: [bbhttpd]


# stop if diabled flag
- name: bbhttpd disabled
  service:
    name: bbhttpd
    state: stopped
  become: yes
  when: rpi_bb_httpd_enabled == false
  tags: [bbhttpd]


# test website deployed - Get page
- name: get index.html content
  uri:
    url: http://127.0.0.1:1080/index.html
    return_content: yes
  register: bbhttpd_index
  ignore_errors: yes
  tags: [bbhttpd]


# check page
- name: test bbhttpd index.html content
  fail:
  when: "'R-Pi BB httpd' not in bbhttpd_index.content"
  ignore_errors: yes
  tags:
    - bbhttpd
    - skip_ansible_lint


- name: roles info txt
  lineinfile:
    path: /opt/cluster/data/info_roles.txt
    line: "{{ role_path|basename }}"
  become: yes
  tags: [bbhttpd]
